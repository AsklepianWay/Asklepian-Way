<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AMPA - Automedida de Presi√≥n Arterial</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="bg-white text-gray-800 font-sans">
  <!-- Pantalla de bienvenida -->
  <section id="bienvenida" class="min-h-screen flex flex-col justify-center items-center bg-blue-50 text-center px-6">
    <h1 class="text-3xl font-bold text-blue-900 mb-4">Bienvenido a tu Cuaderno de AMPA</h1>
    <p class="max-w-xl text-lg text-gray-700 mb-6">
      Realiza tus mediciones de presi√≥n arterial en casa siguiendo las recomendaciones:
    </p>
    <ul class="text-left bg-white rounded-lg shadow p-6 max-w-xl space-y-2 text-sm">
      <li>1. Realiza mediciones en casa durante 3-7 d√≠as antes de la consulta m√©dica.</li>
      <li>2. Mide tu presi√≥n por la ma√±ana y la noche, 2 veces cada vez (4 lecturas al d√≠a).</li>
      <li>3. Si el primer d√≠a no fue representativo, desc√°rtalo.</li>
      <li>4. Mide sentado, en reposo 5 minutos, sin hablar.</li>
      <li>5. Usa siempre el mismo brazo y tensi√≥metro validado.</li>
    </ul>
    <button onclick="mostrarFormulario()" class="mt-6 bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">Comenzar</button>
  </section>

  <!-- Interfaz principal -->
  <section id="formulario" class="hidden min-h-screen px-4 py-8 md:px-20 bg-gray-50">
    <h2 class="text-2xl font-bold text-blue-900 mb-4">Registrar Medici√≥n</h2>
    <div class="bg-white rounded shadow p-6 mb-6 max-w-3xl mx-auto">
      <form onsubmit="guardarMedicion(event)" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <input type="date" id="fecha" class="p-2 border rounded w-full" required />
          <input type="number" id="pas" placeholder="PAS (mmHg)" class="p-2 border rounded w-full" required />
          <input type="number" id="pad" placeholder="PAD (mmHg)" class="p-2 border rounded w-full" required />
        </div>
        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Agregar Medici√≥n</button>
      </form>
    </div>

    <h3 class="text-xl font-semibold text-gray-700 mb-2">Tus mediciones</h3>
    <div class="overflow-x-auto">
      <table class="w-full text-sm table-auto bg-white rounded shadow">
        <thead class="bg-blue-100 text-blue-900">
          <tr>
            <th class="px-4 py-2">Fecha</th>
            <th class="px-4 py-2">PAS (mmHg)</th>
            <th class="px-4 py-2">PAD (mmHg)</th>
          </tr>
        </thead>
        <tbody id="tabla-registros"></tbody>
      </table>
    </div>

    <div id="promedio" class="mt-6 text-center text-lg font-semibold text-gray-800"></div>
    <div id="recomendaciones" class="mt-4 text-center text-base text-gray-700 font-medium"></div>
    <div id="mensaje-final" class="mt-4 text-center text-sm text-gray-500 italic"></div>
    <div id="botones-finales" class="mt-6 text-center hidden">
      <button onclick="descargarPDF()" class="bg-green-600 text-white px-4 py-2 rounded shadow hover:bg-green-700 mr-4">üìÑ Descargar informe en PDF</button>
      <button onclick="reiniciarApp()" class="bg-red-600 text-white px-4 py-2 rounded shadow hover:bg-red-700">üóëÔ∏è Borrar registros</button>
    </div>
  </section>

  <script>
    function mostrarFormulario() {
      document.getElementById('bienvenida').classList.add('hidden');
      document.getElementById('formulario').classList.remove('hidden');
      cargarMediciones();
    }

    function guardarMedicion(event) {
      event.preventDefault();
      const fecha = document.getElementById('fecha').value;
      const pas = parseInt(document.getElementById('pas').value);
      const pad = parseInt(document.getElementById('pad').value);
      if (!fecha || isNaN(pas) || isNaN(pad)) return;

      const nueva = { fecha, pas, pad };
      const datos = JSON.parse(localStorage.getItem('ampas')) || [];
      datos.push(nueva);
      localStorage.setItem('ampas', JSON.stringify(datos));

      document.getElementById('fecha').value = "";
      document.getElementById('pas').value = "";
      document.getElementById('pad').value = "";
      cargarMediciones();
    }

    function cargarMediciones() {
      const registros = JSON.parse(localStorage.getItem('ampas')) || [];
      const tabla = document.getElementById('tabla-registros');
      tabla.innerHTML = "";

      // Mostrar cada registro con posible alerta si es crisis hipertensiva
      registros.forEach(m => {
        const esCrisis = m.pas >= 180 || m.pad >= 110;
        const alerta = esCrisis ? "<span class='text-red-600 text-xs ml-2'>(Consultar urgencias)</span>" : "";
        const fila = `<tr class='text-center border-b'><td class='py-1'>${m.fecha}</td><td>${m.pas}${alerta}</td><td>${m.pad}${alerta}</td></tr>`;
        tabla.innerHTML += fila;
      });

      

      const promedioDiv = document.getElementById('promedio');
      const recomendacionesDiv = document.getElementById('recomendaciones');
      const mensajeFinalDiv = document.getElementById('mensaje-final');
      const botonesFinales = document.getElementById('botones-finales');
      recomendacionesDiv.innerHTML = "";
      mensajeFinalDiv.innerHTML = "";
      botonesFinales.classList.add('hidden');

      if (registros.length >= 7) {
        const pasMedia = Math.round(registros.reduce((acc, val) => acc + val.pas, 0) / registros.length);
        const padMedia = Math.round(registros.reduce((acc, val) => acc + val.pad, 0) / registros.length);

        let clasificacion = "Presi√≥n no elevada (<120/70 mmHg)";
        let recomendaciones = [
          "Sigue manteniendo un estilo de vida saludable.",
          "Contin√∫a con actividad f√≠sica regular y dieta equilibrada."
        ];

        if ((pasMedia >= 120 && pasMedia < 135) || (padMedia >= 70 && padMedia < 85)) {
          clasificacion = "Presi√≥n arterial elevada (120‚Äì134 / 70‚Äì84 mmHg)";
          recomendaciones = [
            "Reduce la ingesta de sal (<5g/d√≠a).",
            "Haz al menos 150 minutos de ejercicio aer√≥bico moderado por semana.",
            "Evita el consumo excesivo de alcohol y limita bebidas azucaradas.",
            "Evita el tabaquismo y maneja el estr√©s."
          ];
        } else if (pasMedia >= 135 || padMedia >= 85) {
          clasificacion = "Hipertensi√≥n arterial domiciliaria (‚â•135 / ‚â•85 mmHg)";
          recomendaciones = [
            "Consulta con tu m√©dico para confirmar el diagn√≥stico.",
            "Reduce el consumo de sal y alimentos ultraprocesados.",
            "Aumenta el consumo de frutas, verduras y potasio natural.",
            "Realiza ejercicio f√≠sico regular seg√∫n tolerancia.",
            "Evita alcohol, tabaco y bebidas estimulantes como caf√© en exceso."
          ];
        }

        promedioDiv.innerText = `Promedio: ${pasMedia}/${padMedia} mmHg - ${clasificacion}`;

        recomendaciones.forEach(r => {
          const p = document.createElement("p");
          p.textContent = `‚Ä¢ ${r}`;
          recomendacionesDiv.appendChild(p);
        });

        mensajeFinalDiv.innerText = "Lleva este resultado a tu profesional de salud para su interpretaci√≥n y seguimiento personalizado.";
        botonesFinales.classList.remove('hidden');
      } else {
        promedioDiv.innerText = "Agrega al menos 7 registros para calcular promedio.";
      }
    }

    function descargarPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const registros = JSON.parse(localStorage.getItem('ampas')) || [];

      let y = 10;
      doc.setFontSize(14);
      doc.text("Informe de AMPA - Automedida de Presi√≥n Arterial", 10, y);
      y += 10;

      registros.forEach((m, i) => {
        const esCrisis = m.pas >= 180 || m.pad >= 110;
        const alerta = esCrisis ? '  Crisis hipertensiva - Consulte urgencias' : '';
        if (esCrisis) {
          doc.setTextColor(200, 0, 0); // rojo
        } else {
          doc.setTextColor(0, 0, 0); // negro
        }
        doc.setFontSize(11);
        doc.text(`${i + 1}. Fecha: ${m.fecha} | PAS: ${m.pas} mmHg | PAD: ${m.pad} mmHg${alerta}`, 10, y);
        y += 7;
      });

      const promedio = document.getElementById('promedio').innerText;
      const recomendaciones = Array.from(document.getElementById('recomendaciones').children).map(p => p.textContent);

      y += 10;
      // Dibuja un resumen visual (barra horizontal con clasificaci√≥n)
      doc.setFontSize(12);
      doc.text(promedio, 10, y);
      y += 8;
      // Determina color seg√∫n categor√≠a
      let color = [100, 200, 100]; // verde por defecto
      if (promedio.includes("Hipertensi√≥n")) color = [255, 100, 100];
      else if (promedio.includes("elevada")) color = [255, 190, 50];
      doc.setFillColor(...color);
      doc.rect(10, y, 180, 6, "F");
      y += 10;
      y += 10;
      doc.setFontSize(11);
      recomendaciones.forEach(r => {
        doc.text(`‚Ä¢ ${r}`, 12, y);
        y += 6;
      });

      y += 10;
      doc.setFontSize(10);
      doc.text("Lleva este informe a tu profesional de salud para su an√°lisis.", 10, y);
      y += 7;
      doc.text("Este sistema de automedici√≥n es una herramienta educativa.", 10, y);
      y += 5;
      doc.text("No reemplaza una valoraci√≥n m√©dica profesional.", 10, y);

      doc.save("Informe_AMPA.pdf");
    }

    function reiniciarApp() {
      localStorage.removeItem('ampas');
      location.reload();
    }
  </script>
</body>
</html>
